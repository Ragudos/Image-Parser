<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>core/src/png.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/Ragudos" target="_blank" class="menu-item" id="repository" >My GitHub</a></h2><h3>Classes</h3><ul><li><a href="CRC.html">CRC</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CRC.html#.calculateCRC">calculateCRC</a></li></ul></li><li><a href="module-utils_debug_errors-UnimplementedError.html">utils/debug/errors~UnimplementedError</a></li><li><a href="module-utils_debug_errors-UnsupportedError.html">utils/debug/errors~UnsupportedError</a></li></ul><h3>Modules</h3><ul><li><a href="module-core_png.html">core/png</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-core_png.html#~getIHDR">getIHDR</a></li><li data-type='method' style='display: none;'><a href="module-core_png.html#~getPNGChunks">getPNGChunks</a></li><li data-type='method' style='display: none;'><a href="module-core_png.html#~isValidPNG">isValidPNG</a></li><li data-type='method' style='display: none;'><a href="module-core_png.html#~processPNG">processPNG</a></li></ul></li><li><a href="module-utils_debug_assert.html">utils/debug/assert</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-utils_debug_assert.html#~assert">assert</a></li></ul></li><li><a href="module-utils_debug_errors.html">utils/debug/errors</a></li><li><a href="module-utils_is.html">utils/is</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-utils_is.html#~isArray">isArray</a></li><li data-type='method' style='display: none;'><a href="module-utils_is.html#~isFunction">isFunction</a></li><li data-type='method' style='display: none;'><a href="module-utils_is.html#~isNumber">isNumber</a></li><li data-type='method' style='display: none;'><a href="module-utils_is.html#~isPlainObject">isPlainObject</a></li><li data-type='method' style='display: none;'><a href="module-utils_is.html#~isString">isString</a></li></ul></li><li><a href="module-utils_numbers_compute_conversion.html">utils/numbers/compute/conversion</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_conversion.html#~bytesTo16BitInt">bytesTo16BitInt</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_conversion.html#~bytesTo16BitUint">bytesTo16BitUint</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_conversion.html#~bytesTo24BitInt">bytesTo24BitInt</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_conversion.html#~bytesTo24BitUint">bytesTo24BitUint</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_conversion.html#~bytesTo32BitInt">bytesTo32BitInt</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_conversion.html#~bytesTo32BitUint">bytesTo32BitUint</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_conversion.html#~int16ToBytes">int16ToBytes</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_conversion.html#~int24ToBytes">int24ToBytes</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_conversion.html#~int32ToBytes">int32ToBytes</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_conversion.html#~int8ToBytes">int8ToBytes</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_conversion.html#~numToBytes">numToBytes</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_conversion.html#~uint16ToBytes">uint16ToBytes</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_conversion.html#~uint24ToBytes">uint24ToBytes</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_conversion.html#~uint32ToBytes">uint32ToBytes</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_conversion.html#~uint8ToBytes">uint8ToBytes</a></li></ul></li><li><a href="module-utils_numbers_compute_engine.html">utils/numbers/compute/engine</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_engine.html#~getBitAt">getBitAt</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_engine.html#~getNumberType">getNumberType</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_engine.html#~isSigned24Bit">isSigned24Bit</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_engine.html#~isSignedByte">isSignedByte</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_engine.html#~isSignedInt">isSignedInt</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_engine.html#~isSignedShort">isSignedShort</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_engine.html#~isUnsigned24Bit">isUnsigned24Bit</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_engine.html#~isUnsignedByte">isUnsignedByte</a></li><li data-type='method' style='display: none;'><a href="module-utils_numbers_compute_engine.html#~isUnsignedShort">isUnsignedShort</a></li></ul></li><li><a href="module-utils_numbers_const.html">utils/numbers/const</a></li></ul><h3>Global</h3><ul><li><a href="global.html#CRC.">CRC.</a></li><li><a href="global.html#PNG_SIGNATURE">PNG_SIGNATURE</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">core/src/png.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @license
 *
 * This code is licensed under the Creative Commons Attribution 4.0 International License (CC BY 4.0).
 * See the LICENSE file for details.
 * Full license text: https://creativecommons.org/licenses/by/4.0/
 * Copyright (c) 2024 Aaron Ragudos
 */

const {
	getBitAt,
	bytesTo32BitUint,
	assert,
	UnimplementedError,
} = require("@image-parser/utils");
const { PNG_SIGNATURE, CHARACTER_ASCII_CODES } = require("./const");
const { CRC } = require("./crc");

/**
 * @fileoverview ALl PNG related operations are in this file.
 * @module core/png
 */

/**
 * @typedef {"IDAT" | "IHDR" | "PLTE" | "IEND"} PngCriticalTypeCodes all PNG special-purpose public chunk types.
 */

/**
 * @typedef {Object} PngChunk
 * @property {number} chunkLength
 * @property {string} typeCode
 * @property {Uint8Array} data
 * @property {number} crc
 * @property {number} calculatedCRC
 * @property {boolean} isCorrupted if `crc` !== `calculatedCRC`
 * @property {boolean} isSafe whether this chunk has an ancillary bit of `1` and is unknown.
 */

/**
 * @typedef {Object} PngMetadata
 * @property {number} width 4 bytes
 * @property {number} height 4 bytes
 * @property {number} bitDepth 1 byte
 * @property {number} colorType 1 byte
 * @property {number} compressionMethod 1 byte
 * @property {number} filterMethod 1 byte
 * @property {number} interlaceMethod 1 byte
 */

/**
 *
 * @param {Uint8Array} _rawData
 */
function processPNG(_rawData) {
	throw new UnimplementedError();

	/*isValidPNG(rawData);

	const chunks = getPNGChunks(rawData);
	const header = getIHDR(chunks);*/
}

/**
 *
 * @param {PngChunk[]} chunks
 *
 * @returns {PngMetadata}
 */
function getIHDR(chunks) {
	assert(
		chunks[0].typeCode === "IHDR",
		"The first chunk is not of type `IHDR`"
	);

	const IHDRChunk = chunks[0];
	const width = bytesTo32BitUint(
		IHDRChunk.data[0],
		IHDRChunk.data[1],
		IHDRChunk.data[2],
		IHDRChunk.data[3]
	);
	const height = bytesTo32BitUint(
		IHDRChunk.data[4],
		IHDRChunk.data[5],
		IHDRChunk.data[6],
		IHDRChunk.data[7]
	);
	const bitDepth = IHDRChunk.data[8];
	const colorType = IHDRChunk.data[9];
	const compressionMethod = IHDRChunk.data[10];
	const filterMethod = IHDRChunk.data[11];
	const interlaceMethod = IHDRChunk.data[12];

	return {
		width,
		height,
		bitDepth,
		colorType,
		filterMethod,
		compressionMethod,
		interlaceMethod,
	};
}

/**
 *
 * @param {Uint8Array} rawData
 *
 * @returns {Array&lt;PngChunk>}
 */
function getPNGChunks(rawData) {
	let offset = 8;

	/**
	 * @type {Array&lt;PngChunk>}
	 */
	const chunks = [];

	while (offset &lt; rawData.length) {
		const chunkLength = bytesTo32BitUint(
			rawData[offset++],
			rawData[offset++],
			rawData[offset++],
			rawData[offset++]
		);

		// TODO: calculate the CRC here to check for data corruption of the chunk.
		const calculatedCRC = CRC.calculateCRC(
			rawData.slice(offset, offset + 4 + chunkLength)
		);

		const ancillaryBit = rawData[offset++];
		const privacyBit = rawData[offset++];
		const reservedBit = rawData[offset++];
		const safeToCopyBit = rawData[offset++];
		const isCriticalChunk = getBitAt(ancillaryBit, 5) === 0;
		const typeCode = String.fromCharCode(
			ancillaryBit,
			privacyBit,
			reservedBit,
			safeToCopyBit
		);
		const data = rawData.slice(offset, (offset += chunkLength));
		const crc = bytesTo32BitUint(
			rawData[offset++],
			rawData[offset++],
			rawData[offset++],
			rawData[offset++]
		);

		chunks.push({
			chunkLength,
			typeCode,
			data,
			crc,
			calculatedCRC,
			isCorrupted: crc !== calculatedCRC,
			isSafe:
				isCriticalChunk &amp;&amp;
				ancillaryBit !== CHARACTER_ASCII_CODES.I &amp;&amp;
				ancillaryBit !== CHARACTER_ASCII_CODES.P,
		});
	}

	return chunks;
}

/**
 *
 * @param {Uint8Array} rawData
 */
function isValidPNG(rawData) {
	for (let i = 0; i &lt; PNG_SIGNATURE.length; ++i) {
		if (rawData[i] !== PNG_SIGNATURE[i]) {
			throw new TypeError();
		}
	}
}

module.exports = { processPNG, getIHDR, getPNGChunks, isValidPNG };
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.3</a> on Tue Sep 03 2024 14:00:06 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
